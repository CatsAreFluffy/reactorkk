<html><head></head><body onload="run()">
<span id="bux">Money: $10</span>
<span id="power">Power: 0/100</span>
<button onclick="sellpower()">Sell!</button>
<span id="heat">Heat: 0/1000</span><br>
<button onclick="prevItem()">&lt;</button>
<span id="item">Uranium Cell</span>
<button onclick="nextItem()">&gt;</button><br>
<canvas id="game" width=450 height=450 style="border:1px solid #000000;">
You can't run the game :( ^ Update your browser to play ^
</canvas>
<script>
function run(){
    window.canvas=document.getElementById("game")
    window.canvasleft=canvas.offsetLeft
    window.canvastop=canvas.offsetTop
    window.context=canvas.getContext("2d")
    window.bux=10
    window.power=0
    window.maxpower=100
    window.heat=0
    window.buxpertick=0
    window.item=0
    window.items=[
    {name:"uranium1",gname:"Uranium Cell ($10)",cost:10,default:{type:"cell",image:"uranium1",income:1,heat:1,power:15,capacity:0,sell:0}},
    {name:"uranium2",gname:"Dual Uranium Cell ($25)",cost:25,default:{type:"cell",image:"uranium2",income:4,heat:8,power:15,capacity:0,sell:0}},
    {name:"uranium4",gname:"Quad Uranium Cell ($60)",cost:60,default:{type:"cell",image:"uranium4",income:12,heat:36,power:15,capacity:0,sell:0}},
    {name:"uranium8",gname:"Octo Uranium Cell ($140)",cost:140,default:{type:"cell",image:"uranium4",income:32,heat:128,power:15,capacity:0,sell:0}},
    {name:"vent1",gname:"Basic Vent ($50)",cost:50,default:{type:"vent",image:"vent1",capacity:40,vent:4,heat:0,sell:50}},
    {name:"cap1",gname:"Basic Capacitor ($1K)",cost:1000,default:{type:"capacitor",image:"cap1",power:100,capacity:10,heat:0,sell:1000}}
    ]
    window.reactor=[]
    for(var i=0;i<=canvas.width/30;i++){
        reactor.push([])
        for(var j=0;j<=canvas.width/30;j++){
            reactor[reactor.length-1].push({type:"empty",explosion:0})
        }
    }
    canvas.onclick=click
    canvas.oncontextmenu=rclick
    setInterval(income,500)
    drawGrid()
    context.stroke()
    loadImages()
}
function drawGrid(){
    context.beginPath()
    for(var i=30;i<canvas.width;i+=30){
        context.moveTo(i,0)
        context.lineTo(i,canvas.height)
    }
    for(var i=30;i<canvas.height;i+=30){
        context.moveTo(0,i)
        context.lineTo(canvas.width,i)
    }
}
function loadImages(){
    var images=["uranium1","uranium1d","uranium2","uranium2d","uranium4","uranium4d","vent1","cap1"]
    for(var i=0;i<images.length;i++){
        window[images[i]+"img"]=new Image()
        window[images[i]+"img"].src="./"+images[i]+".png"
    }
}
function click(event){
    var x=event.pageX-canvasleft
    var y=event.pageY-canvastop
    var ioffset=18
    var ooffset=3
    var scale=30
    x=(x-ioffset)/scale;y=(y-ioffset)/scale
    x=Math.round(x);y=Math.round(y)
    gridx=x;gridy=y
    x=x*scale+ooffset;y=y*scale+ooffset
    var object=items[item]
    if(bux>=object.cost&&reactor[gridx][gridy].type=="empty"){
        reactor[gridx][gridy]=Object.assign({drawx:x,drawy:y},object.default)
        updateBux(-object.cost)
    }
}
function rclick(event){
    var x=event.pageX-canvasleft
    var y=event.pageY-canvastop
    var ioffset=18
    var ooffset=3
    var scale=30
    x=(x-ioffset)/scale;y=(y-ioffset)/scale
    x=Math.round(x);y=Math.round(y)
    gridx=x;gridy=y
    x=x*scale+ooffset;y=y*scale+ooffset
    var cell=reactor[gridx][gridy]
    if(cell.type!="empty"){
        reactor[gridx][gridy]={type:"empty",explosion:0}
        updateBux(cell.sell)
    }
    return false;
}
function sellpower(){
    updateBux(power)
    updatePower(-power)
}
function nextItem(){
        item+=1
        item%=items.length
        update("item",items[item].gname)
}
function prevItem(){
        if(!item){item=items.length}
        item-=1
        update("item",items[item].gname)
}
function income(){
    buxpertick=0
    context.clearRect(0, 0, canvas.width, canvas.height)
    for(var i=0;i<reactor.length;i++){ //heat plus tick
        for(var j=0;j<reactor[i].length;j++){
            cell=reactor[i][j]
            switch(cell.type){
                case "empty":
                    break;
                case "cell":
                    addheat(i,j,cell.heat)
                    break;
                case "dcell":
                    break;
                case "vent":
                    break;
                case "capacitor":
                    break;
                default:
                    console.log("Unexpected item: "+cell.type)
            }
        }
    }
    for(var i=0;i<reactor.length;i++){ //heat minus tick
        for(var j=0;j<reactor[i].length;j++){
            cell=reactor[i][j]
            switch(cell.type){
                case "empty":
                    break;
                case "cell":
                    break;
                case "dcell":
                    break;
                case "vent":
                    cell.heat-=cell.vent
                    if(cell.heat<0){cell.heat=0}
                    break;
                case "capacitor":
                    break;
                default:
                    console.log("Unexpected item: "+cell.type)
            }
        }
    }
    for(var i=0;i<reactor.length;i++){ //generic tick
        for(var j=0;j<reactor[i].length;j++){
            cell=reactor[i][j]
            switch(cell.type){
                case "empty":
                    break;
                case "cell":
                    context.drawImage(window[cell["image"]+"img"],cell["drawx"],cell["drawy"])
                    buxpertick+=cell["income"]
                    cell["power"]--
                    if(!cell["power"]){cell["type"]="dcell";cell["image"]+="d"}
                    break;
                case "dcell":
                    context.drawImage(window[cell["image"]+"img"],cell["drawx"],cell["drawy"])
                    break;
                case "vent":
                    context.drawImage(window[cell.image+"img"],cell.drawx,cell.drawy)
                    if(cell.heat>cell.capacity){
                        reactor[i][j]={type:"empty",explosion:4}
                    }
                    break;
                case "capacitor":
                    if(cell.heat>cell.capacity){
                        reactor[i][j]={type:"empty",explosion:4}
                    }
                    break;
                default:
                    console.log("Unexpected item: "+cell.type)
            }
            if(heat>1000){reactor[i][j]={type:"empty",explosion:4}}
        }
    }
    drawGrid()
    context.stroke()
    updatePower(buxpertick)
    updateHeat(-0.1)
}
function update(thing,value){
    document.getElementById(thing).innerHTML=value
}
function updateBux(amount){
    bux+=amount
    update("bux","Money: $"+bux)
}
function updatePower(amount){
    power+=amount
    if(power>maxpower){power=maxpower}
    update("power","Power: "+power+"/"+maxpower)
}
function updateHeat(amount){
    heat+=amount
    clampheat()
    update("heat","Heat: "+heat+"/1000")
}
function addheat(x,y,heat){
    var cells=[]
    if(x>0){cells.push(reactor[x-1][y])}
    if(y>0){cells.push(reactor[x][y-1])}
    if(x<reactor.length-1){cells.push(reactor[x+1][y])}
    if(y<reactor[0].length-1){cells.push(reactor[x][y+1])}
    var heatcells=[]
    for(var i=0;i<cells.length;i++){
        if(cells[i].capacity>0){heatcells.push(cells[i])}
    }
    if(heatcells.length){
        for(var i=0;i<heatcells.length;i++){
            heatcells[i].heat+=heat/heatcells.length
        }
    }else{
        updateHeat(heat)
    }
}
function clampheat(){
        if(heat<0){heat=0}
        heat=Math.round(heat*10)/10
}
    
</script>
